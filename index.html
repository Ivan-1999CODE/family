<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æœ¬æ—…éŠè‹±æ–‡æœƒè©±æ‰‹å†Š (+AIå£èªª)</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Inter å­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Markdown Parser for AI feedback formatting -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* æ‡‰ç”¨å­—é«” */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #eef1f5;
        }
        .tab-content {
            min-height: 400px;
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* éš±è—æ»¾å‹•æ¢ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* è‡ªå®šç¾©æ’­æ”¾æŒ‰éˆ•æ¨£å¼ (æ°£æ³¡å…§) */
        .bubble-play-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            cursor: pointer;
            margin-left: 8px;
            flex-shrink: 0;
        }
        .left-bubble .bubble-play-btn { background-color: #edf2f7; color: #4a5568; }
        .left-bubble .bubble-play-btn:hover { background-color: #cbd5e0; color: #2d3748; }
        .right-bubble .bubble-play-btn { background-color: #ffffff; color: #10b981; opacity: 0.9; }
        .right-bubble .bubble-play-btn:hover { opacity: 1; transform: scale(1.05); }

        /* éŒ„éŸ³æŒ‰éˆ•å‹•ç•« */
        .recording {
            animation: pulse-red 1.5s infinite;
            background-color: #EF4444 !important;
            color: white !important;
            border-color: #EF4444 !important;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="text-gray-800 pb-10">

    <!-- ä¸»å®¹å™¨ -->
    <div class="container mx-auto max-w-3xl p-4 relative z-10">

        <!-- æ¨™é¡Œ -->
        <header class="text-center my-6">
            <h1 class="text-3xl font-bold text-blue-700">æ—¥æœ¬æ—…éŠè‹±æ–‡æœƒè©±</h1>
            <p class="text-gray-600 mt-2">ç¥æ‚¨ 12 æœˆæ—…é€”æ„‰å¿«ï¼</p>
        </header>

        <!-- Tab å°èˆªæ¬„ -->
        <nav class="sticky top-0 z-30 bg-white shadow-md rounded-lg mb-6">
            <div class="flex overflow-x-auto whitespace-nowrap no-scrollbar border-b border-gray-200">
                <button class="tab-button active-tab" onclick="showTab('tab-customs')">
                    <span class="text-xl md:text-2xl">ğŸ›‚</span><span class="ml-2">å…¥å¢ƒ</span>
                </button>
                <button class="tab-button" onclick="showTab('tab-hotel')">
                    <span class="text-xl md:text-2xl">ğŸ¨</span><span class="ml-2">ä½å®¿</span>
                </button>
                <button class="tab-button" onclick="showTab('tab-restaurant')">
                    <span class="text-xl md:text-2xl">ğŸ½ï¸</span><span class="ml-2">é»é¤</span>
                </button>
                <button class="tab-button" onclick="showTab('tab-shopping')">
                    <span class="text-xl md:text-2xl">ğŸ›’</span><span class="ml-2">è³¼ç‰©</span>
                </button>
                <button class="tab-button" onclick="showTab('tab-transport')">
                    <span class="text-xl md:text-2xl">ğŸ—ºï¸</span><span class="ml-2">äº¤é€š</span>
                </button>
                <button class="tab-button text-indigo-600 font-bold bg-indigo-50" onclick="showTab('tab-speaking')">
                    <span class="text-xl md:text-2xl">ğŸ—£ï¸</span><span class="ml-2">å£èªªæ¸¬é©—</span>
                </button>
            </div>
        </nav>

        <!-- Tab å…§å®¹å€åŸŸ (èƒŒæ™¯æ¨¡æ“¬èŠå¤©å®¤) -->
        <main class="bg-[#729ec4] rounded-xl shadow-inner min-h-[500px] p-4 relative overflow-hidden">
            <!-- èƒŒæ™¯è£é£¾ -->
            <div class="absolute inset-0 opacity-10 pointer-events-none" style="background-image: url('https://www.transparenttextures.com/patterns/diamond-upholstery.png');"></div>

            <!-- 1. å…¥å¢ƒ/æµ·é—œ -->
            <div id="tab-customs" class="tab-content relative z-10">
                <div class="bg-blue-800 text-white text-center py-2 rounded-lg mb-4 text-sm opacity-80 shadow-sm">
                    ğŸ›‚ å…¥å¢ƒå¯©æŸ¥ (Immigration)
                </div>
                <div id="content-customs" class="space-y-4 pb-4"></div>
            </div>

            <!-- 2. é£¯åº—ä½å®¿ -->
            <div id="tab-hotel" class="tab-content relative z-10 hidden">
                <div class="bg-blue-800 text-white text-center py-2 rounded-lg mb-4 text-sm opacity-80 shadow-sm">
                    ğŸ¨ é£¯åº—ä½å®¿ (Hotel Check-in & Service)
                </div>
                <div id="content-hotel" class="space-y-4 pb-4"></div>
            </div>

            <!-- 3. é¤å»³é»é¤ -->
            <div id="tab-restaurant" class="tab-content relative z-10 hidden">
                <div class="bg-blue-800 text-white text-center py-2 rounded-lg mb-4 text-sm opacity-80 shadow-sm">
                    ğŸ½ï¸ é¤å»³ç”¨é¤ (Dining & Ordering)
                </div>
                <div id="content-restaurant" class="space-y-4 pb-4"></div>
            </div>

            <!-- 4. è³¼ç‰© -->
            <div id="tab-shopping" class="tab-content relative z-10 hidden">
                <div class="bg-blue-800 text-white text-center py-2 rounded-lg mb-4 text-sm opacity-80 shadow-sm">
                    ğŸ›’ å•†åº—è³¼ç‰© (Shopping)
                </div>
                <div id="content-shopping" class="space-y-4 pb-4"></div>
            </div>

            <!-- 5. å•è·¯/äº¤é€š -->
            <div id="tab-transport" class="tab-content relative z-10 hidden">
                <div class="bg-blue-800 text-white text-center py-2 rounded-lg mb-4 text-sm opacity-80 shadow-sm">
                    ğŸ—ºï¸ äº¤é€šæŒ‡å¼• (Transportation & Directions)
                </div>
                <div id="content-transport" class="space-y-4 pb-4"></div>
            </div>

            <!-- 6. å£èªªæ¸¬é©—æ¨¡å¼ (éš±è— Key è¼¸å…¥æ¡†ç‰ˆæœ¬) -->
            <div id="tab-speaking" class="tab-content bg-white rounded-lg shadow-lg p-5 hidden relative z-20">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b pb-4">
                    <div>
                        <h2 class="text-2xl font-bold text-indigo-700">ğŸ—£ï¸ AI å£èªªæ¨¡æ“¬æ¸¬é©—</h2>
                        <p class="text-sm text-gray-500 mt-1">æ‚¨æ˜¯éŠå®¢ï¼Œè«‹å®Œæˆä»¥ä¸‹ 3 å€‹æƒ…å¢ƒé¡Œã€‚</p>
                    </div>
                    <button onclick="startQuiz()" class="mt-3 md:mt-0 px-5 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow-md flex items-center">
                        <i class="fas fa-random mr-2"></i> é–‹å§‹æ–°æ¸¬é©—
                    </button>
                </div>

                <!-- æ³¨æ„ï¼šé€™è£¡å·²ç¶“æ²’æœ‰ API Key çš„è¼¸å…¥æ¡†äº†ï¼Œè«‹åœ¨ä¸‹æ–¹ JavaScript ç¨‹å¼ç¢¼ä¸­è¨­å®š -->

                <!-- æ¸¬é©—å€åŸŸ -->
                <div id="quiz-container" class="space-y-8">
                    <p class="text-center text-gray-500 py-10">è«‹é»æ“Šä¸Šæ–¹ã€Œé–‹å§‹æ–°æ¸¬é©—ã€æŒ‰éˆ•é–‹å§‹ç·´ç¿’ã€‚</p>
                </div>

                <!-- é€å‡ºæŒ‰éˆ• -->
                <div id="submit-area" class="hidden mt-8 text-center border-t pt-6">
                    <button onclick="submitQuiz()" id="submitBtn" class="px-8 py-3 bg-green-600 text-white text-lg font-bold rounded-full hover:bg-green-700 transition shadow-lg transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-paper-plane mr-2"></i> é€å‡ºçµ¦ AI æ‰¹æ”¹
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- JavaScript é‚è¼¯ -->
    <script>
        // ==========================================
        // â­ è«‹åœ¨æ­¤è™•å¡«å…¥æ‚¨çš„ Google Gemini API Key â­
        // ==========================================
        const apiKey = "AIzaSyBwORAUO3cNO-yzy9JSI7Lk2yqSULgRckM"; // åœ¨é€™è£¡å¡«å…¥ï¼Œä¾‹å¦‚: const apiKey = "AIzaSy...";
        
        // --- 1. è³‡æ–™åº« (Quiz Data) ---
        const quizData = [
            // Customs (Immigration)
            { category: 'customs', role: 'Officer', en: "May I see your passport, please?", ch: "è«‹å‡ºç¤ºæ‚¨çš„è­·ç…§ã€‚" },
            { category: 'customs', role: 'Traveler', en: "Here is my passport.", ch: "é€™æ˜¯æˆ‘çš„è­·ç…§ã€‚" },
            { category: 'customs', role: 'Officer', en: "What is the purpose of your visit?", ch: "æ‚¨æ­¤è¡Œçš„ç›®çš„æ˜¯ä»€éº¼ï¼Ÿ" },
            { category: 'customs', role: 'Traveler', en: "I'm here for travel.", ch: "æˆ‘ä¾†é€™è£¡æ—…éŠã€‚" },
            { category: 'customs', role: 'Officer', en: "How long will you be staying?", ch: "æ‚¨æœƒåœç•™å¤šä¹…ï¼Ÿ" },
            { category: 'customs', role: 'Traveler', en: "I will be staying for 7 days.", ch: "æˆ‘æœƒåœç•™7å¤©ã€‚" },
            { category: 'customs', role: 'Officer', en: "Where will you be staying?", ch: "æ‚¨æœƒä½åœ¨å“ªè£¡ï¼Ÿ" },
            { category: 'customs', role: 'Traveler', en: "I'm staying at this Hotel in Tokyo.", ch: "æˆ‘æœƒä½åœ¨æ±äº¬çš„é€™å®¶é£¯åº—ã€‚" },
            { category: 'customs', role: 'Officer', en: "Do you have anything to declare?", ch: "æ‚¨æœ‰ä»»ä½•ç‰©å“éœ€è¦ç”³å ±å—ï¼Ÿ" },
            { category: 'customs', role: 'Traveler', en: "No, nothing to declare.", ch: "æ²’æœ‰ï¼Œæ²’æœ‰æ±è¥¿è¦ç”³å ±ã€‚" },
            
            // Airport Essentials
            { category: 'customs', role: 'Traveler', en: "I'd like to exchange some money.", ch: "æˆ‘æƒ³æ›ä¸€äº›éŒ¢ã€‚" },
            { category: 'customs', role: 'Staff', en: "Sure, please fill out this form first.", ch: "å¥½çš„ï¼Œè«‹å…ˆå¡«å¯«é€™å¼µè¡¨æ ¼ã€‚" },
            
            // Hotel
            { category: 'hotel', role: 'Traveler', en: "Can I check in, please?", ch: "æˆ‘æƒ³è¦è¾¦ç†å…¥ä½ã€‚" },
            { category: 'hotel', role: 'Staff', en: "Sure, may I have your passport?", ch: "å¥½çš„ï¼Œè«‹è®“æˆ‘çœ‹ä¸€ä¸‹æ‚¨çš„è­·ç…§ã€‚" },
            { category: 'hotel', role: 'Traveler', en: "What time is check-out?", ch: "è«‹å•å¹¾é»é€€æˆ¿ï¼Ÿ" },
            { category: 'hotel', role: 'Staff', en: "Check-out is at 11 AM.", ch: "é€€æˆ¿æ™‚é–“æ˜¯ä¸Šåˆ11é»ã€‚" },
            { category: 'hotel', role: 'Traveler', en: "Can I store my luggage here?", ch: "æˆ‘å¯ä»¥åœ¨é€™è£¡å¯„æ”¾è¡Œæå—ï¼Ÿ" },
            { category: 'hotel', role: 'Staff', en: "Sure, we can keep it at the front desk.", ch: "æ²’å•é¡Œï¼Œæˆ‘å€‘å¯ä»¥å¯„æ”¾åœ¨æ«ƒå°ã€‚" },
            { category: 'hotel', role: 'Traveler', en: "What time is breakfast?", ch: "è«‹å•æ—©é¤æ˜¯å¹¾é»ï¼Ÿ" },
            { category: 'hotel', role: 'Staff', en: "Breakfast is served from 7 to 10 AM.", ch: "æ—©é¤ä¾›æ‡‰æ™‚é–“æ˜¯7é»åˆ°10é»ã€‚" },
            { category: 'hotel', role: 'Traveler', en: "Can I have the Wi-Fi password?", ch: "è«‹å• Wi-Fi å¯†ç¢¼æ˜¯ä»€éº¼ï¼Ÿ" },
            { category: 'hotel', role: 'Staff', en: "It is 'hotel123'.", ch: "å¯†ç¢¼æ˜¯'hotel123'ã€‚" },
            { category: 'hotel', role: 'Traveler', en: "Can I get a pillow, please?", ch: "å¯ä»¥è«‹ä½ çµ¦æˆ‘ä¸€å€‹æ•é ­å—ï¼Ÿ" },
            { category: 'hotel', role: 'Staff', en: "Certainly, I'll bring one to your room.", ch: "æ²’å•é¡Œï¼Œæˆ‘æœƒé€åˆ°æ‚¨çš„æˆ¿é–“ã€‚" },
            
            // Restaurant
            { category: 'restaurant', role: 'Traveler', en: "I have a reservation.", ch: "æˆ‘æœ‰é ç´„ã€‚" },
            { category: 'restaurant', role: 'Staff', en: "May I have your name, please?", ch: "è«‹å•æ‚¨çš„åå­—æ˜¯ï¼Ÿ" },
            { category: 'restaurant', role: 'Traveler', en: "Can I make a reservation?", ch: "æˆ‘å¯ä»¥é ç´„å—ï¼Ÿ" },
            { category: 'restaurant', role: 'Staff', en: "For what time and how many people?", ch: "è«‹å•æ™‚é–“å’Œäººæ•¸ï¼Ÿ" },
            { category: 'restaurant', role: 'Traveler', en: "Which one do you recommend?", ch: "ä½ æ¨è–¦å“ªä¸€å€‹ï¼Ÿ" },
            { category: 'restaurant', role: 'Staff', en: "The beef tongue set is very popular.", ch: "ç‰›èˆŒå¥—é¤éå¸¸å—æ­¡è¿ã€‚" },
            { category: 'restaurant', role: 'Traveler', en: "I would like a hamburger.", ch: "æˆ‘è¦ä¸€å€‹æ¼¢å ¡ã€‚" },
            { category: 'restaurant', role: 'Staff', en: "Would you like a drink with that?", ch: "è«‹å•éœ€è¦æ­é…é£²æ–™å—ï¼Ÿ" },
            { category: 'restaurant', role: 'Traveler', en: "How much is this?", ch: "é€™å€‹å¤šå°‘éŒ¢ï¼Ÿ" },
            { category: 'restaurant', role: 'Staff', en: "It is 1,000 yen.", ch: "æ˜¯1,000æ—¥åœ“ã€‚" },
            { category: 'restaurant', role: 'Traveler', en: "How much are these?", ch: "é€™äº›å¤šå°‘éŒ¢ï¼Ÿ" },
            { category: 'restaurant', role: 'Staff', en: "They are 2,500 yen.", ch: "ç¸½å…±æ˜¯2,500æ—¥åœ“ã€‚" },
            { category: 'restaurant', role: 'Staff', en: "For here or to go?", ch: "å…§ç”¨é‚„æ˜¯å¤–å¸¶ï¼Ÿ" },
            { category: 'restaurant', role: 'Traveler', en: "For here, please.", ch: "å…§ç”¨ï¼Œè¬è¬ã€‚" },
            { category: 'restaurant', role: 'Traveler', en: "Can I get the check, please?", ch: "éº»ç…©è«‹çµ¦æˆ‘å¸³å–®ã€‚" },
            { category: 'restaurant', role: 'Staff', en: "Here is your bill.", ch: "é€™æ˜¯æ‚¨çš„å¸³å–®ã€‚" },

            // Shopping
            { category: 'shopping', role: 'Traveler', en: "Can I try this on?", ch: "æˆ‘å¯ä»¥è©¦ç©¿é€™å€‹å—ï¼Ÿ" },
            { category: 'shopping', role: 'Staff', en: "Yes, the fitting room is over there.", ch: "å¯ä»¥ï¼Œè©¦è¡£é–“åœ¨é‚£é‚Šã€‚" },
            { category: 'shopping', role: 'Traveler', en: "Do you have this in a different size?", ch: "é€™å€‹æœ‰åˆ¥çš„å°ºå¯¸å—ï¼Ÿ" },
            { category: 'shopping', role: 'Staff', en: "Let me check the stock for you.", ch: "æˆ‘å¹«æ‚¨æŸ¥ä¸€ä¸‹åº«å­˜ã€‚" },
            { category: 'shopping', role: 'Traveler', en: "How much is it?", ch: "é€™å€‹å¤šå°‘éŒ¢ï¼Ÿ" },
            { category: 'shopping', role: 'Staff', en: "It is 3,000 yen.", ch: "æ˜¯3,000æ—¥åœ“ã€‚" },
            { category: 'shopping', role: 'Traveler', en: "How much are they?", ch: "é€™äº›å¤šå°‘éŒ¢ï¼Ÿ" },
            { category: 'shopping', role: 'Staff', en: "They are 1,000 yen each.", ch: "æ¯å€‹1,000æ—¥åœ“ã€‚" },
            { category: 'shopping', role: 'Traveler', en: "Can I pay by credit card?", ch: "æˆ‘å¯ä»¥åˆ·å¡å—ï¼Ÿ" },
            { category: 'shopping', role: 'Staff', en: "Yes, we accept VISA and Mastercard.", ch: "å¯ä»¥ï¼Œæˆ‘å€‘æ¥å— VISA å’Œè¬äº‹é”å¡ã€‚" },
            { category: 'shopping', role: 'Traveler', en: "Can I have a bag, please?", ch: "å¯ä»¥çµ¦æˆ‘ä¸€å€‹è¢‹å­å—ï¼Ÿ" },
            { category: 'shopping', role: 'Staff', en: "Sure, here you go.", ch: "å¥½çš„ï¼Œçµ¦æ‚¨ã€‚" },

            // Transport
            { category: 'transport', role: 'Traveler', en: "I'd like to buy a ticket to Shinjuku.", ch: "æˆ‘æƒ³è²·ä¸€å¼µå»æ–°å®¿çš„ç¥¨ã€‚" },
            { category: 'transport', role: 'Staff', en: "That will be 200 yen.", ch: "é‚£æ¨£æ˜¯200æ—¥åœ“ã€‚" },
            { category: 'transport', role: 'Traveler', en: "I'd like to recharge my Suica card.", ch: "æˆ‘æƒ³å„²å€¼æˆ‘çš„è¥¿ç“œå¡ (Suica)ã€‚" },
            { category: 'transport', role: 'Staff', en: "Please use the ticket machine.", ch: "è«‹ä½¿ç”¨å”®ç¥¨æ©Ÿã€‚" },
            { category: 'transport', role: 'Traveler', en: "Which platform is for Tokyo Station?", ch: "å»æ±äº¬è»Šç«™æ˜¯åœ¨ç¬¬å¹¾æœˆå°ï¼Ÿ" },
            { category: 'transport', role: 'Staff', en: "Track number 2.", ch: "ç¬¬2æœˆå°ã€‚" },
            { category: 'transport', role: 'Traveler', en: "How do I get there?", ch: "æˆ‘è¦æ€éº¼å»é‚£è£¡ï¼Ÿ" },
            { category: 'transport', role: 'Passerby', en: "You can take the subway.", ch: "ä½ å¯ä»¥æ­åœ°éµã€‚" },
            { category: 'transport', role: 'Traveler', en: "Do you know where a convenience store is?", ch: "ä½ çŸ¥é“ä¾¿åˆ©å•†åº—åœ¨å“ªè£¡å—ï¼Ÿ" },
            { category: 'transport', role: 'Passerby', en: "Go straight and turn left.", ch: "ç›´èµ°ç„¶å¾Œå·¦è½‰ã€‚" },
            { category: 'transport', role: 'Traveler', en: "Could you show me where it is on the map?", ch: "ä½ å¯ä»¥åœ¨åœ°åœ–ä¸ŠæŒ‡çµ¦æˆ‘çœ‹å—ï¼Ÿ" },
            { category: 'transport', role: 'Passerby', en: "It's right here.", ch: "å°±åœ¨é€™è£¡ã€‚" },
            { category: 'transport', role: 'Traveler', en: "How long does it take?", ch: "è¦èŠ±å¤šä¹…æ™‚é–“ï¼Ÿ" },
            { category: 'transport', role: 'Passerby', en: "About 10 minutes.", ch: "å¤§ç´„10åˆ†é˜ã€‚" },
            { category: 'transport', role: 'Traveler', en: "Does this train stop at Shibuya?", ch: "é€™ç­è»Šæœƒåœæ¾€è°·å—ï¼Ÿ" },
            { category: 'transport', role: 'Passerby', en: "Yes, it does.", ch: "æ˜¯çš„ï¼Œæœƒåœã€‚" }
        ];

        // --- 2. åˆå§‹åŒ–ï¼šæ¸²æŸ“å­¸ç¿’æ¨¡å¼ ---
        function renderLearningContent() {
            const categories = ['customs', 'hotel', 'restaurant', 'shopping', 'transport'];
            
            categories.forEach(cat => {
                const container = document.getElementById(`content-${cat}`);
                if(!container) return;

                const items = quizData.filter(item => item.category === cat);
                
                items.forEach(item => {
                    const div = document.createElement('div');
                    const isMe = item.role === 'Traveler';
                    const alignClass = isMe ? 'justify-end' : 'justify-start';
                    const avatarHtml = !isMe ? `<div class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-gray-300 flex items-center justify-center mr-2 flex-shrink-0 border-2 border-white shadow-sm overflow-hidden"><i class="fas ${item.role === 'Officer' ? 'fa-user-shield' : 'fa-user'} text-gray-600 text-sm md:text-base"></i></div>` : '';
                    const bubbleBaseClass = "relative max-w-[85%] md:max-w-[75%] px-4 py-3 shadow-sm text-sm md:text-base";
                    const bubbleStyleClass = isMe ? "bg-[#8be667] text-black rounded-2xl rounded-tr-none right-bubble" : "bg-white text-gray-800 rounded-2xl rounded-tl-none border border-gray-200 left-bubble";
                    let roleName = 'å°æ–¹';
                    if (item.role === 'Officer') roleName = 'æµ·é—œäººå“¡';
                    else if (item.role === 'Passerby') roleName = 'è·¯äºº';
                    else if (item.role === 'Staff') roleName = 'åº—å“¡/ç«™å‹™å“¡';
                    const nameLabel = !isMe ? `<div class="text-xs text-gray-600 mb-1 ml-12">${roleName}</div>` : '';

                    div.className = `w-full flex flex-col mb-4`;
                    div.innerHTML = `
                        ${nameLabel}
                        <div class="flex ${alignClass} items-start">
                            ${avatarHtml}
                            <div class="${bubbleBaseClass} ${bubbleStyleClass} group">
                                <div class="flex items-start justify-between gap-3">
                                    <div class="font-medium leading-relaxed">${item.en}</div>
                                    <button class="bubble-play-btn" onclick="speakText(\`${item.en.replace(/'/g, "\\'")}\`)"><i class="fas fa-volume-up text-xs md:text-sm"></i></button>
                                </div>
                                <div class="text-xs ${isMe ? 'text-green-900' : 'text-gray-500'} mt-1 border-t ${isMe ? 'border-green-400/30' : 'border-gray-100'} pt-1">${item.ch}</div>
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                });
            });
        }

        // --- 3. Tab åˆ‡æ› ---
        const activeTabClasses = ['bg-blue-600', 'text-white', 'shadow-md'];
        const inactiveTabClasses = ['text-gray-600', 'hover:bg-gray-100'];
        const baseTabClasses = ['flex-shrink-0', 'py-3', 'px-4', 'md:px-6', 'font-medium', 'text-sm', 'md:text-base', 'transition-all', 'duration-200', 'flex', 'items-center', 'justify-center', 'rounded-t-lg', 'md:rounded-lg', 'mx-1'];

        function initTabs() {
            document.querySelectorAll('.tab-button').forEach(button => button.classList.add(...baseTabClasses));
            showTab('tab-customs');
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(btn => {
                if(btn.textContent.includes('å£èªªæ¸¬é©—')) {
                    btn.className = `tab-button text-indigo-600 font-bold bg-indigo-50 ${baseTabClasses.join(' ')}`;
                } else {
                    btn.classList.remove(...activeTabClasses);
                    btn.classList.add(...inactiveTabClasses);
                }
            });
            document.getElementById(tabId).classList.remove('hidden');
            const activeBtn = document.querySelector(`button[onclick="showTab('${tabId}')"]`);
            if(activeBtn) {
                if(tabId === 'tab-speaking') {
                    activeBtn.className = `tab-button bg-indigo-600 text-white shadow-md ${baseTabClasses.join(' ')}`;
                } else {
                    activeBtn.classList.remove(...inactiveTabClasses);
                    activeBtn.classList.add(...activeTabClasses);
                }
                activeBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        }

        // --- 4. èªéŸ³æ’­æ”¾ (TTS) ---
        function speakText(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 0.9;
                const voices = window.speechSynthesis.getVoices();
                let selectedVoice = voices.find(voice => voice.name === 'Google US English');
                if (!selectedVoice) selectedVoice = voices.find(voice => voice.lang === 'en-US' && voice.name.toLowerCase().includes('female'));
                if (!selectedVoice) selectedVoice = voices.find(voice => voice.lang === 'en-US' && (voice.name.includes('Zira') || voice.name.includes('Samantha')));
                if (selectedVoice) utterance.voice = selectedVoice;
                window.speechSynthesis.speak(utterance);
            } else {
                alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³æ’­æ”¾åŠŸèƒ½ã€‚');
            }
        }

        // --- 5. å£èªªæ¸¬é©—é‚è¼¯ ---
        let currentQuizQuestions = [];
        let recognition;
        let isRecording = false;
        let currentRecordingIndex = null;

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                if (currentRecordingIndex !== null) {
                    const input = document.getElementById(`answer-${currentRecordingIndex}`);
                    input.value = (input.value + ' ' + transcript).trim();
                    stopRecordingUI();
                }
            };

            recognition.onerror = function(event) { stopRecordingUI(); alert('èªéŸ³è¾¨è­˜éŒ¯èª¤'); };
            recognition.onend = function() { stopRecordingUI(); };
        }

        function toggleRecording(index) {
            if (!recognition) { alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜"); return; }
            if (isRecording && currentRecordingIndex === index) { recognition.stop(); }
            else {
                if (isRecording) recognition.stop();
                setTimeout(() => {
                    try { recognition.start(); currentRecordingIndex = index; isRecording = true;
                        const btn = document.getElementById(`mic-btn-${index}`);
                        btn.classList.add('recording'); btn.innerHTML = '<i class="fas fa-stop"></i>';
                    } catch(e) { console.error(e); }
                }, 200);
            }
        }

        function stopRecordingUI() {
            isRecording = false;
            if (currentRecordingIndex !== null) {
                const btn = document.getElementById(`mic-btn-${currentRecordingIndex}`);
                if(btn) { btn.classList.remove('recording'); btn.innerHTML = '<i class="fas fa-microphone"></i>'; }
                currentRecordingIndex = null;
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function startQuiz() {
            const travelerItems = quizData.filter(item => item.role === 'Traveler');
            const responseItems = quizData.filter(item => item.role !== 'Traveler');
            
            const shuffledTraveler = shuffleArray([...travelerItems]);
            const shuffledResponse = shuffleArray([...responseItems]);
            
            const q1 = shuffledTraveler[0];
            const q2 = shuffledResponse[0];
            const q3 = shuffledTraveler[1];
            
            currentQuizQuestions = [q1, q2, q3];
            
            const container = document.getElementById('quiz-container');
            container.innerHTML = '';

            currentQuizQuestions.forEach((q, index) => {
                const isTranslation = q.role === 'Traveler';
                let typeLabel, promptHtml, hintText;
                
                if (isTranslation) {
                    typeLabel = '<span class="bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded font-bold">ç¿»è­¯ä»»å‹™</span>';
                    promptHtml = `<h3 class="text-xl font-bold text-gray-800 mb-1">è«‹ç”¨è‹±æ–‡èªªï¼šã€Œ${q.ch}ã€</h3>`;
                    hintText = "(æç¤ºï¼šé»æ“Šå³å´å–‡å­å¯è½è§£ç­”ï¼Œä½†æ²’æœ‰å­—å¹•å–”ï¼)";
                } else {
                    typeLabel = '<span class="bg-purple-100 text-purple-700 text-xs px-2 py-1 rounded font-bold">å›ç­”ä»»å‹™</span>';
                    let roleName = q.role === 'Officer' ? 'æµ·é—œäººå“¡' : (q.role === 'Passerby' ? 'è·¯äºº' : 'åº—å“¡');
                    promptHtml = `<h3 class="text-lg font-bold text-gray-800 mb-1">${roleName} å°ä½ èªªï¼š<br>"${q.en}"</h3><p class="text-sm text-gray-500 mb-2">(${q.ch})</p><p class="text-md font-medium text-indigo-600">è«‹ç”¨è‹±æ–‡å›ç­”...</p>`;
                    hintText = "(æç¤ºï¼šé»æ“Šå–‡å­å¯é‡è½å°æ–¹çš„å•é¡Œ)";
                }

                const card = document.createElement('div');
                card.className = 'bg-white border border-gray-200 rounded-xl p-5 shadow-sm transition hover:shadow-md';
                card.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="inline-block px-2 py-1 bg-gray-100 text-gray-500 text-xs rounded">Question ${index + 1}</span>
                            ${typeLabel}
                        </div>
                        ${promptHtml}
                        <div class="flex items-center mt-2">
                            <button onclick="speakText(\`${q.en.replace(/'/g, "\\'")}\`)" class="flex items-center gap-2 px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full text-sm text-gray-700 transition">
                                <i class="fas fa-volume-up"></i> ${isTranslation ? 'æ’­æ”¾è§£ç­”æç¤ºéŸ³' : 'æ’­æ”¾å•é¡ŒèªéŸ³'}
                            </button>
                            <span class="text-xs text-gray-400 ml-2">${hintText}</span>
                        </div>
                    </div>
                    
                    <div class="relative">
                        <textarea id="answer-${index}" rows="2" class="w-full p-3 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none resize-none" placeholder="é»æ“Šéº¥å…‹é¢¨æˆ–æ˜¯ç›´æ¥è¼¸å…¥æ‚¨çš„è‹±æ–‡å›ç­”..."></textarea>
                        <button id="mic-btn-${index}" onclick="toggleRecording(${index})" class="absolute right-2 bottom-2 w-10 h-10 bg-gray-100 text-gray-600 rounded-full hover:bg-gray-200 flex items-center justify-center transition-colors" title="èªéŸ³è¼¸å…¥">
                            <i class="fas fa-microphone"></i>
                        </button>
                    </div>

                    <div id="feedback-${index}" class="hidden mt-4 p-4 rounded-lg bg-gray-50 text-sm leading-relaxed border border-gray-100"></div>
                `;
                container.appendChild(card);
            });

            document.getElementById('submit-area').classList.remove('hidden');
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i> é€å‡ºçµ¦ AI æ‰¹æ”¹';
        }

        async function submitQuiz() {
            if (!apiKey) {
                alert("è«‹å…ˆåœ¨ç¨‹å¼ç¢¼ä¸­å¡«å…¥æ‚¨çš„ Google Gemini API Keyã€‚");
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> AI è€å¸«æ‰¹æ”¹ä¸­...';

            const promises = currentQuizQuestions.map(async (q, index) => {
                const userAnswer = document.getElementById(`answer-${index}`).value.trim();
                const feedbackDiv = document.getElementById(`feedback-${index}`);
                const isTranslation = q.role === 'Traveler';
                
                feedbackDiv.classList.remove('hidden');
                feedbackDiv.innerHTML = '<span class="text-gray-500"><i class="fas fa-circle-notch fa-spin mr-1"></i> åˆ†æä¸­...</span>';

                try {
                    const feedback = await callGeminiAPI(apiKey, q, userAnswer, isTranslation);
                    
                    const refAnswerHtml = isTranslation ? `
                        <div class="mt-3 pt-3 border-t border-gray-200 flex items-center">
                            <span class="text-xs font-bold text-gray-500 mr-2">åƒè€ƒè§£ç­”:</span>
                            <span class="text-gray-800 mr-2">${q.en}</span>
                            <button class="play-button w-6 h-6 text-sm" onclick="speakText(\`${q.en.replace(/'/g, "\\'")}\`)"><i class="fas fa-volume-up"></i></button>
                        </div>` : '';

                    feedbackDiv.innerHTML = `
                        <div class="prose prose-sm max-w-none">
                            <strong class="text-indigo-600 block mb-2">ğŸ’¡ AI è€å¸«å»ºè­°ï¼š</strong>
                            ${marked.parse(feedback)}
                        </div>
                        ${refAnswerHtml}
                    `;
                    feedbackDiv.className = 'mt-4 p-4 rounded-lg bg-indigo-50 border border-indigo-100 text-sm';
                } catch (error) {
                    feedbackDiv.innerHTML = `<span class="text-red-500">åˆ†æå¤±æ•—: ${error.message}</span>`;
                }
            });

            await Promise.all(promises);
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-check mr-2"></i> æ‰¹æ”¹å®Œæˆ';
        }

        async function callGeminiAPI(key, question, userAnswer, isTranslation) {
            if (!userAnswer) return "æ‚¨æ²’æœ‰å›ç­”é€™é¡Œå–”ï¼";

            let prompt = "";
            const systemPrompt = "ä½ æ˜¯ä½å‹å–„ã€é¼“å‹µå­¸ç”Ÿçš„è‹±æ–‡å®¶æ•™ã€‚ä½ çš„ä»»å‹™æ˜¯è©•ä¼°å­¸ç”Ÿçš„è‹±æ–‡å›ç­”ï¼Œä¸¦æä¾›å…·é«”çš„æ”¹é€²å»ºè­°ã€‚è«‹ç›¡é‡ç°¡æ½”ã€‚å°±ç®—å­¸ç”Ÿçš„ç­”æ¡ˆå¾ˆç°¡å–®ï¼Œä¹Ÿè¦é¼“å‹µä»–å€‘ä¸¦å»ºè­°ä¸€å€‹æ›´å®Œæ•´æˆ–æ›´è‡ªç„¶çš„èªªæ³•ã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚ä½ çš„å›è¦†å¿…é ˆæ˜¯è‡ªç„¶çš„æ®µè½ï¼Œä¸è¦ä½¿ç”¨ä»»ä½•æ¨™é¡Œã€é …ç›®ç¬¦è™Ÿã€æ˜Ÿè™Ÿ(**)æˆ–äº•å­—è™Ÿ(###)ç­‰ markdown æ¨™è¨˜ã€‚";

            if (isTranslation) {
                prompt = `
                    ${systemPrompt}
                    æƒ…å¢ƒï¼šéŠå®¢æƒ³è¦è©¢å•æˆ–ç´¢å–æ±è¥¿ã€‚
                    ä¸­æ–‡æç¤º: "${question.ch}"
                    æ¨™æº–ç­”æ¡ˆç¯„ä¾‹: "${question.en}"
                    å­¸ç”Ÿçš„å›ç­”ï¼š"${userAnswer}"
                    
                    è«‹è©•ä¼°å­¸ç”Ÿçš„å›ç­”ã€‚
                    1. æä¾›ç°¡çŸ­ã€é¼“å‹µæ€§çš„æ„è¦‹ã€‚
                    2. å¦‚æœæœ‰èª¤ï¼Œè«‹æº«å’Œåœ°ä¿®æ­£ã€‚
                    3. å»ºè­°ä¸€å€‹ã€Œæ›´è‡ªç„¶ä½†åŒæ¨£ç°¡å–®ã€çš„èªªæ³•ã€‚
                    4. (é‡è¦) ä¸è¦æä¾›å¤ªé›£æˆ–å¤ªé•·çš„å¥å­ï¼Œé€™äº›å­¸ç”Ÿæ˜¯åˆå­¸è€…ã€‚
                `;
            } else {
                prompt = `
                    ${systemPrompt}
                    æƒ…å¢ƒï¼šéŠå®¢(å­¸ç”Ÿ)æ­£åœ¨æ—¥æœ¬æ—…éŠï¼Œé‡åˆ°äº† ${question.role}ã€‚
                    ${question.role} çš„è‹±æ–‡å•é¡Œ: "${question.en}" (ä¸­æ–‡æ„æ€: ${question.ch})
                    å­¸ç”Ÿçš„å›ç­”ï¼š"${userAnswer}"
                    
                    è«‹è©•ä¼°å­¸ç”Ÿçš„å›ç­”ã€‚
                    1. æä¾›ç°¡çŸ­ã€é¼“å‹µæ€§çš„æ„è¦‹ã€‚
                    2. åˆ¤æ–·å­¸ç”Ÿçš„å›ç­”æ˜¯å¦åˆä¹é‚è¼¯ä¸”æœ‰ç¦®è²Œã€‚
                    3. ä¿®æ­£ä»»ä½•æ–‡æ³•éŒ¯èª¤ã€‚
                    4. å»ºè­°ä¸€å€‹å¥½çš„å›ç­”ç¯„ä¾‹ã€‚
                    5. (é‡è¦) ä¸è¦æä¾›å¤ªé›£æˆ–å¤ªé•·çš„å¥å­ã€‚
                `;
            }

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`;
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (e) {
                console.error(e);
                throw e;
            }
        }

        window.onload = function() {
            renderLearningContent();
            initTabs();
        };
    </script>

</body>
</html>
